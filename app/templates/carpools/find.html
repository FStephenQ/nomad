{%- extends "_template.html" %}
{%- import "bootstrap/wtf.html" as wtf %}

{% block scripts %}
{{super()}}
<script>
var place = null;
var map = null;

$(function () {
    $('#submit').on('click', function() {
        doSearch();
    });
});

function doSearch() {
    var url = '{{ url_for('carpool.start_geojson') }}?';
    var parts = [];

    if (place) {
        parts.push('near.lat=' + encodeURIComponent(place.geometry.location.lat()));
        parts.push('near.lon=' + encodeURIComponent(place.geometry.location.lng()));
    }

    url += parts.join('&');

    var results = $('#search-results');
    results.empty();
    map.data.forEach(function(feature) {
        map.data.remove(feature);
    });
    map.data.loadGeoJson(url, null, mapDataCallback);
}

function initMap() {
    map = new google.maps.Map(document.getElementById('background-map'), {
        center: {lat: 38.518, lng: -97.328},
        zoom: 12,
        styles: mapStyleDiscreet
    });
    doSearch();

    var from_input = document.getElementById('locationQuery');
    var from_ac = new google.maps.places.Autocomplete(from_input, {
        componentRestrictions: {country: 'us'},
        options: ['(regions)'],
    });
    from_ac.bindTo('bounds', map);
    from_ac.addListener('place_changed', function() {
        var chosen = from_ac.getPlace();

        if (!chosen.geometry) {
            console.log("No details available for form autocomplete: '" + chosen.name + "'");
            return;
        }

        place = chosen;
        doSearch();
    });

    // need to figure out where this makes sense to include custom markers

    // for (var i=0; i < baltLocations.length; i++) {
    //     markers.push(new google.maps.Marker({
    //         position: new google.maps.LatLng(baltLocations[i].lat, baltLocations[i].lng),
    //         map: map,
    //         icon: normalIcon()
    //     }));
    // }

}

function showCarpoolDetails(carpoolId) {
    $.ajax({
        type: "GET",
        url: carpoolId + '/embed',
        success: function(data) {
            $('#detail-pane').html(data);
            $('#detail-pane').show();
        }
    })
}

function showCarpoolDetailsDivClickHandler(event) {
    showCarpoolDetails(event.data);
}

function mapDataCallback(features) {
    var results = $('#search-results');
    results.empty();
    for (var i = 0; i < features.length; i++) {
        var feature = features[i];
        var resultdiv = $('<div class="result"><h3 class="result-title">' + feature.getProperty('from_place') + ' to ' + feature.getProperty('to_place') + '</h3><p>' + feature.getProperty('seats_available') + ' seats available</p><p>Departs: ' + feature.getProperty('leave_time') + '</p><p>Returns: ' + feature.getProperty('return_time') + '</p><p>Destination: '+ feature.getProperty('to_place') + '</p></div>');
        resultdiv.click(feature.getId(), showCarpoolDetailsDivClickHandler);
        results.append(resultdiv);
    }

    map.data.addListener('click', function(event) {
        showCarpoolDetails(event.feature.getId());
    });
}

function normalIcon() {
  return {
    url: 'img/ic_marker_inactive.png'
    };
}
function highlightedIcon() {
  return {
    url: 'img/ic_marker_active.png'
  };
}
</script>
<script src="https://maps.googleapis.com/maps/api/js?key={{config.get('GOOGLE_MAPS_API_KEY')}}&libraries=places&callback=initMap" async defer></script>
{% endblock %}

{% block site %}


<div class="content constrained">

    <div class="left-bar">
        <h1>Find rides near you</h1>
        <div id="search-results">
        </div>
    </div>

    <!-- <div class="right-bar active"> -->
    <div class="right-bar">
        <div id="background-map"></div>
        <div id="detail-pane" class="active"></div>
    </div>

</div>

{% endblock %}
